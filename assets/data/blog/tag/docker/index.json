{"hash":"ea117f9eaf93a10f57b7c08c27bee15658b6712f","data":{"tag":{"title":"docker","belongsTo":{"edges":[{"node":{"title":"Secure reverse proxy using Authelia and NGINX Proxy Manager and Docker","slug":"use-authelia-with-nginx-proxy-manager","date_posted":"August 17, 2021","date_updated":"August 20, 2021","path":"/blog/use-authelia-with-nginx-proxy-manager/","description":"Setting up Authelia and NGINX Proxy Manager to add TOTP and password protection to your hosted services.","content":"<p>NGINX Proxy Manager is a fantastic GUI frontend for NGINX that simplifies the process of adding and managing hosts, as well as generating SSL certificates using Let's Encrypt. It's a great way to organize local services across physical devices, containers, and virtual machines.</p>\n<p>While NGINX Proxy Manager does protect itself with a username and password, the same may not be true for every given service you're proxying. Additionally, it (and most other services) will not offer any options for Two-Factor Authentication (2FA). Enter <a href=\"https://github.com/authelia/authelia\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Authelia</a>.</p>\n<blockquote>\n<p>Authelia is an open-source authentication and authorization server providing two-factor authentication and single sign-on (SSO) for your applications via a web portal. It acts as a companion for reverse proxies like nginx, Traefik or HAProxy to let them know whether requests should either be allowed or redirected to Authelia's portal for authentication.</p>\n</blockquote>\n<p>This article assumes you have a reasonable familiarity with Docker, Docker Compose, NGINX, Let's Encrypt, and more. Basically, you need to know the specific things I know -- which isn't many things, but it is some things.</p>\n<h2 id=\"setup\"><a href=\"#setup\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Setup</h2>\n<p>We'll be using <a href=\"https://docs.docker.com/compose/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">docker-compose</a> for this setup, but this can of course be adapted to a variety of other configurations based on your needs. First, create a directory for this project:</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> ~/nginx-proxy-manager\n<span class=\"token builtin class-name\">cd</span> ~/nginx-proxy-manager</code></pre></div>\n<h3 id=\"secrets\"><a href=\"#secrets\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Secrets</h3>\n<p>Let's create a directory for our <strong>secrets</strong>. Docker secrets allow us to use sensitive data without entering it directly into our <code class=\"language-inline-text\">docker-compose.yml</code>. Essentially, we will be mounting these files into our container where they can be read as environment variables by our <code class=\"language-inline-text\">root</code> user.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> .secrets\n<span class=\"token function\">chmod</span> <span class=\"token number\">700</span> .secrets</code></pre></div>\n<p>Create the following <code class=\"language-inline-text\">docker-compose.yml</code>:</p>\n<div class=\"gridsome-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"2.1\"</span>\n\n<span class=\"token key atrule\">secrets</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">authelia_jwt_secret</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span> .secrets/authelia_jwt_secret\n  <span class=\"token key atrule\">authelia_session_secret</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span> .secrets/authelia_session_secret\n  <span class=\"token key atrule\">insecure_session_secret</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span> .secrets/insecure_session_secret\n  <span class=\"token key atrule\">authelia_notifier_smtp_password</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span> .secrets/authelia_notifier_smtp_password\n  <span class=\"token key atrule\">db_root_pwd</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span> .secrets/db_root_pwd\n  <span class=\"token key atrule\">mysql_pwd</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span> .secrets/mysql_pwd\n\n<span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">default</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">external</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> proxy\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">npm</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>proxy<span class=\"token punctuation\">-</span>manager\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'jc21/nginx-proxy-manager:latest'</span>\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'80:80'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'443:443'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'81:81'</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">DB_MYSQL_HOST</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"db\"</span>\n      <span class=\"token key atrule\">DB_MYSQL_PORT</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3306</span>\n      <span class=\"token key atrule\">DB_MYSQL_USER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"npm\"</span>\n      <span class=\"token key atrule\">DB_MYSQL_PASSWORD__FILE</span><span class=\"token punctuation\">:</span> /run/secrets/mysql_pwd\n      <span class=\"token key atrule\">DB_MYSQL_NAME</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"npm\"</span>\n      <span class=\"token key atrule\">DISABLE_IPV6</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./npm<span class=\"token punctuation\">:</span>/data\n      <span class=\"token punctuation\">-</span> ./npm<span class=\"token punctuation\">-</span>conf<span class=\"token punctuation\">:</span>/data/nginx/custom\n      <span class=\"token punctuation\">-</span> ./letsencrypt<span class=\"token punctuation\">:</span>/etc/letsencrypt\n    <span class=\"token key atrule\">secrets</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> mysql_pwd\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> db\n\n  <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>db\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jc21/mariadb<span class=\"token punctuation\">-</span>aria\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">MYSQL_ROOT_PASSWORD__FILE</span><span class=\"token punctuation\">:</span> /run/secrets/db_root_pwd\n      <span class=\"token key atrule\">MYSQL_DATABASE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"npm\"</span>\n      <span class=\"token key atrule\">MYSQL_USER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"npm\"</span>\n      <span class=\"token key atrule\">MYSQL_PASSWORD__FILE</span><span class=\"token punctuation\">:</span> /run/secrets/mysql_pwd\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./mysql<span class=\"token punctuation\">:</span>/var/lib/mysql\n    <span class=\"token key atrule\">secrets</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> db_root_pwd\n      <span class=\"token punctuation\">-</span> mysql_pwd\n\n  <span class=\"token key atrule\">authelia</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> authelia/authelia<span class=\"token punctuation\">:</span>latest\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> authelia\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> TZ=America/Vancouver\n      <span class=\"token punctuation\">-</span> AUTHELIA_JWT_SECRET_FILE=/run/secrets/authelia_jwt_secret\n      <span class=\"token punctuation\">-</span> AUTHELIA_SESSION_SECRET_FILE=/run/secrets/authelia_session_secret\n      <span class=\"token punctuation\">-</span> AUTHELIA_NOTIFIER_SMTP_PASSWORD_FILE=/run/secrets/authelia_notifier_smtp_password\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./authelia<span class=\"token punctuation\">:</span>/config\n    <span class=\"token key atrule\">secrets</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> authelia_jwt_secret\n      <span class=\"token punctuation\">-</span> authelia_session_secret\n      <span class=\"token punctuation\">-</span> authelia_notifier_smtp_password\n      <span class=\"token punctuation\">-</span> insecure_session_secret\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped</code></pre></div>\n<h2 id=\"nginx-proxy-manager\"><a href=\"#nginx-proxy-manager\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>NGINX Proxy Manager</h2>\n<p>You'll need to create a Proxy Host for your Authelia instance. Create a new Proxy Host (e.g. <code class=\"language-inline-text\">auth.example.com</code>) and point it to your Authelia host, port, and protocol in the Details tab. Then, add the following to the Custom Configuration block on the Advanced tab:</p>\n<div class=\"gridsome-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token directive\"><span class=\"token keyword\">set</span> <span class=\"token variable\">$upstream_authelia</span> http://authelia:9091</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> <span class=\"token variable\">$upstream_authelia</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">client_body_buffer_size</span> <span class=\"token number\">128k</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">#Timeout if the real server is dead</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_next_upstream</span> error timeout invalid_header http_500 http_502 http_503</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\"># Advanced Proxy Config</span>\n    <span class=\"token directive\"><span class=\"token keyword\">send_timeout</span> <span class=\"token number\">5m</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_read_timeout</span> <span class=\"token number\">360</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_send_timeout</span> <span class=\"token number\">360</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_connect_timeout</span> <span class=\"token number\">360</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\"># Basic Proxy Config</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> Host <span class=\"token variable\">$host</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Real-IP <span class=\"token variable\">$remote_addr</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-Proto <span class=\"token variable\">$scheme</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-Host <span class=\"token variable\">$http_host</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-Uri <span class=\"token variable\">$request_uri</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-Ssl <span class=\"token boolean\">on</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_redirect</span>  http://  <span class=\"token variable\">$scheme</span>://</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_http_version</span> 1.1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> Connection <span class=\"token string\">\"\"</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_cache_bypass</span> <span class=\"token variable\">$cookie_session</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_no_cache</span> <span class=\"token variable\">$cookie_session</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_buffers</span> <span class=\"token number\">64</span> <span class=\"token number\">256k</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\"># If behind reverse proxy, forwards the correct IP, assumes you're using Cloudflare. Adjust IP for your Docker network.</span>\n    <span class=\"token directive\"><span class=\"token keyword\">set_real_ip_from</span> 172.19.0.0/16</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">real_ip_header</span> CF-Connecting-IP</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">real_ip_recursive</span> <span class=\"token boolean\">on</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Finally, you can add the following snippet in the Advanced tab for a Proxy Host to protect it with Authelia:</p>\n<div class=\"gridsome-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">include</span> /data/nginx/custom/authelia-server.conf</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token directive\"><span class=\"token keyword\">include</span> /data/nginx/custom/authelia-location.conf</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> <span class=\"token variable\">$forward_scheme://</span><span class=\"token variable\">$server</span>:<span class=\"token variable\">$port</span></span> <span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n"}}]}}},"context":{}}